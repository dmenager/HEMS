(in-package :hems)
;;(load "graph-representation")

;; node-def = list describing node contents in attribute-value pair format. :kb-concept-id is optional.
(defun make-bn-node (node-def)
  (cond ((symbolp (car node-def))
	 (let ((cpd (make-rule-based-cpd))
	       (type-identifier)
	       (identifiers (make-hash-table :test #'equal))
	       (vars (make-hash-table))
	       (types-hash (make-hash-table))
	       (cids (make-hash-table))
	       (vvbm (make-hash-table))
	       (sva (make-hash-table))
	       (svna (make-hash-table))
	       (vals (make-hash-table))
	       (cards)
	       (steps)
	       (type)
	       (concept-id (getf node-def :kb-concept-id))
	       (value (getf node-def :value))
	       (supported-keywords '(:value :kb-concept-id))
	       (node-def-kwds (remove-if-not #'keywordp node-def))
	       (unsupported))
	   (setq unsupported (set-difference node-def-kwds supported-keywords :test #'equal))
	   (when unsupported
	     (error "Unsupported keywords 窿蕃 in node defintion list." unsupported))
	   (when (null value)
	     (error "No value field found in node definition list."))
	   (cond ((or (equal "PERCEPT-NODE" (symbol-name (car node-def)))
		      (equal "RELATION-NODE" (symbol-name (car node-def))))
		  (cond ((and (symbolp (second node-def))
			      (not (null (second node-def))))
			 (if (equal "PERCEPT-NODE" (symbol-name (car node-def)))
			     (setf (gethash 0 types-hash) "PERCEPT")
			     (setf (gethash 0 types-hash) "BELIEF"))
			 (setq type (symbol-name (second node-def)))
			 (setf (rule-based-cpd-dependent-var cpd) type)
			 (setf (gethash 0 vars) type)
			 (setf (rule-based-cpd-vars cpd) vars)
			 (setq type-identifier (symbol-name (gensym type)))
			 (setf (rule-based-cpd-dependent-id cpd) type-identifier)
			 (setf (gethash type-identifier identifiers) 0)
			 (setf (rule-based-cpd-identifiers cpd) identifiers)
			 (setf (rule-based-cpd-types cpd) types-hash)
			 (setf (rule-based-cpd-concept-blocks cpd) (make-hash-table))
			 (setf (rule-based-cpd-count cpd) 1)
			 (setf (gethash 0 vvbm) (list (list (cons "NA" 0) (make-hash-table))))
			 (setf (gethash 0 sva) (list (list 0)))
			 (setf (gethash 0 svna) (list nil))
			 (setf (gethash 0 vals) (list 0))
			 (setq cards (generate-cpd-cardinalities vvbm))
			 (setq steps (generate-cpd-step-sizes cards))
			 (cond ((or (null concept-id)
				    (stringp concept-id))
				(if concept-id
				    (setf (gethash 0 cids) concept-id)
				    (setf (gethash 0 cids) "NIL"))
				(setf (rule-based-cpd-concept-ids cpd) cids)
				(setf (rule-based-cpd-qualified-vars cpd)
				      (generate-cpd-vars identifiers vars cids))
				(cond ((stringp value)
				       (when (not (string-equal "NA" value))
					 (cond ((equal "PERCEPT-NODE" (symbol-name (car node-def)))
						(setf (gethash 0 vvbm) (list (list (cons "NA" 0) (make-hash-table))
									     (list (cons value 1) (make-hash-table)))))
					       ((equal "RELATION-NODE" (symbol-name (car node-def)))
						(when (not (equal "T" value))
						  (error "Relation node values must be \"T\" or \"NA\". S is unsupported." value))
						(setf (gethash 0 vvbm) (list (list (cons "NA" 0) (make-hash-table))
									     (list (cons "T" 1) (make-hash-table))))))
					 (setf (gethash 0 sva) (list (list 0) (list 1)))
					 (setf (gethash 0 svna) (list (list 1) (list 0)))
					 (setf (gethash 0 vals) (list 0 1))
					 (setq cards (generate-cpd-cardinalities vvbm))
					 (setq steps (generate-cpd-step-sizes cards)))
				       (setf (rule-based-cpd-var-value-block-map cpd) vvbm)
				       (setf (rule-based-cpd-negated-vvbms cpd)
					     (copy-hash-table vvbm))
				       (setf (rule-based-cpd-set-valued-attributes cpd) sva)
				       (setf (rule-based-cpd-set-valued-negated-attributes cpd) svna)
				       (setf (rule-based-cpd-lower-approx-var-value-block-map cpd)
					     (copy-hash-table vvbm))
				       (setf (rule-based-cpd-lower-approx-negated-vvbms cpd)
					     (copy-hash-table vvbm))
				       (setf (rule-based-cpd-characteristic-sets cpd)
					     (make-hash-table))
				       (setf (rule-based-cpd-characteristic-sets-values cpd)
					     (make-hash-table))
				       (setf (rule-based-cpd-var-values cpd) vals)
				       (setf (rule-based-cpd-cardinalities cpd) cards)
				       (setf (rule-based-cpd-step-sizes cpd) steps)
				       cpd)
				      ((numberp value)
				       (error "Numeric value, A, not yet supported in node definition list. Expected string." value))
				      (t
				       (error "Unsupported value, A, for value in node definition list.%Received type A. Expected string or numeric." value (type-of value)))))
			       (t
				(error "Unsupported value, A, for concept id in node definition list.%Received type A. Expected string." concept-id (type-of concept-id)))))
			(t
			 (raise-identifier-type-error (second node-def)))))
		 (t
		  (error "Unsupported type, A for node definition list." (car node-def))))))
	(t
	 (raise-identifier-type-error (car node-def)))))
  

(defun raise-identifier-type-error (recieved)
  (error "Unsupported identifier A. Expoected type of non-nil symbol." recieved))

(defun directed-edge (cpd1 cpd2)
  (modify-cpd cpd2 cpd1))

(defun topological-sort (factors-list)
  (let (l s copy)
    (setq copy (copy-factors (make-array (length factors-list) :initial-contents factors-list)))
    (loop
      for cpd being the elements of copy
      when (= (hash-table-count (rule-based-cpd-identifiers cpd)) 1)
	do
	   (setq s (cons cpd s)))
    (loop
      while s
      do
	 (setq l (reverse (cons (car s) (reverse l))))
	 (setq s (rest s))
	 (loop
	   for cpd being the elements of copy
	   for cpd1 in factors-list
	   when (gethash (rule-based-cpd-dependent-id (car l))
			 (rule-based-cpd-identifiers cpd))
	     do
		(remhash (rule-based-cpd-dependent-id (car l))
			 (rule-based-cpd-identifiers cpd))
		(when (= (hash-table-count (rule-based-cpd-identifiers cpd)) 1)
		  (setq l (reverse (cons cpd1 (reverse l)))))))
    l))

(defmacro compile-program (&body body)
  (let ((hash (gensym))
	(args (gensym))
	(ident (gensym))
	(cpd (gensym))
	(cpd-list (gensym))
	(factors (gensym))
	(edges (gensym)))
    `(labels ((compile-hems-program (,hash ,args)
		(cond (,args
		       (if (and (symbolp (first ,args))
				(not (null (first ,args))))
			   (cond ((equal '= (second ,args))
				  (cond ((listp (third ,args))
					 (when (gethash (first ,args) ,hash)
					   (warn "Attempting to overwrite value for identifyer A." (first ,args)))
					 (setf (gethash (first ,args) ,hash)
					       (make-bn-node (third ,args))))
					(t
					 (error "Expected assignment to list.%Received: 窿篚怏羼狎珞畅┅┅è羼踽Л箦泔钿狎珞┅麒孱铒ㄧ弭栳箬ㄦ轵篝狎珞栳箬┅ㄥ蝌矧⒁彐弪孱沐麸忮骘蝈狍箝珙礤铘ㄦ轵篝狎珞┅ㄣ镱è犷簌礅镬翳轵狎珞┅铒铛祆翳轵狎珞┅┅麒孱铒ㄧ弭栳箬翳轵狎珞栳箬┅ㄥ蝌矧⒁彐弪孱沐麸忮骘蝈狍箝珙礤铘翳轵狎珞┅ㄤ轵邈翦洵邃珏ㄧ弭栳箬ㄦ轵篝狎珞栳箬ㄧ弭栳箬翳轵狎珞栳箬┅蜥轶瀛殇孱糸骈弪豉疱弪蝻聃雉翳轵狎珞┅换ㄥ蝌矧⒄铙躔痫螋邃殇孱糸骈弪豉疱廉砒疱泗邃铒瞽铋簌礅镬豉疱镦翳轵狎珞┅┅麒孱铒ㄧ弭栳箬翳轵狎珞栳箬┅┅ㄥ蝌矧⒄铗邈镧铋邃镳弪狒矧义沐轹邃廉ヅ疱泗邃狍箝珙礤铘矧溟蝈泗邃邃珏箦泔钿狎珞┅┅蜥轶瀛殇孱糸骈弪豉疱弪蝻聃雉ㄦ轵篝狎珞┅ㄣ镯痖戾桢眢痱镧蜥栳箬铘桡潋狎珞┅祜镳鏖翳驷泗矧犷邃珏骘殇孱忮轭翳栳箬脲镦栳箬躞轭ㄨ狍璀鲠祯沭洎泔祆邈沭轭麸沭洵扉篝骈钺祆箦赳驷泗矧磲脲狎蜥ㄨ狍璀翎忪瀛泔躅栳箬洪铋糸犰泔铘孱趔ㄦ轭犰辁瀛驷泗矧麸痫祜玳汜飙箫螋沭洵扉篝┅┅箦赳邃珏磲脲珧狃璀邃珏驷泗矧螬蝈趱蝾ㄣ镱驷泗矧邃珏螬┅┅┅ㄣ镯痖戾桢眢痱镧蜥磲脲栳箬翎忪呼弩＇羼踽飑К怙澌┅┅ㄤ彐躅翦篝泔眇殪弪ī戾ㄢ畋忸博箦赳忸ㄣ镯痖戾痱镧蜥惚疱蜚屦舡铒溴汜篚犰豉忽犰蹂⒚劣樟淘侪立弘猸泔钽屦舡殇⒚涡原雹悴疱蜚屦舡铒溴徵忽犰蹂⒉并弘猸泔钽屦舡殇⒚涡原并愠疱蜚屦舡铒溴箦忽犰蹂⑼弘猸泔钽屦舡殇⒚涡原尝愦疱蜚屦舡铒溴蜥铍忽犰蹂⑼商稍烈佗弘猸泔钽屦舡殇⒚涡原储愕疱蜚屦舡铒溴栩痦轭忽犰蹂⒈吹弘猸泔钽屦舡殇⒚涡原耽愣疱蜚屦舡铒溴眄惹忽犰蹂⒍阿弘猸泔钽屦舡殇⒚涡原盯惴疱蜚屦舡铒溴羽锊忽犰蹂⒏耽弘猸泔钽屦舡殇⒚涡原发愀疱蜚屦舡铒溴乙忽犰蹂⒋阿弘猸泔钽屦舡殇⒚涡原涪愎疱蜚屦舡铒溴疳轭忽犰蹂阿弘猸泔钽屦舡殇⒚涡原耿惚悴惚愠惚愦惚愕惚愣惚惴惚愀惚愎┅箦赳忸ㄣ镯痖戾痱镧蜥惚疱蜚屦舡铒溴汜篚犰豉忽犰蹂⒚劣樟淘侪垄弘猸泔钽屦舡殇⒚涡原雹惚疱蜚屦舡铒溴徵忽犰蹂⒉耽弘猸泔钽屦舡殇⒚涡原并惚疱蜚屦舡铒溴箦忽犰蹂⑼弘猸泔钽屦舡殇⒚涡原尝惚疱蜚屦舡铒溴蜥铍忽犰蹂⑼商稍烈佗弘猸泔钽屦舡殇⒚涡原储惚疱蜚屦舡铒溴栩痦轭忽犰蹂⒈舶弘猸泔钽屦舡殇⒚涡原耽惚疱蜚屦舡铒溴眄惹忽犰蹂⒏阿弘猸泔钽屦舡殇⒚涡原盯惚疱蜚屦舡铒溴羽锊忽犰蹂⒐涪弘猸泔钽屦舡殇⒚涡原发惚疱蜚屦舡铒溴乙忽犰蹂⒈涪弘猸泔钽屦舡殇⒚涡原涪惚疱蜚屦舡铒溴疳轭忽犰蹂⒍弘猸泔钽屦舡殇⒚涡原耿惚惚惚惚惚惚惚惚惚惚惚惚惚惚惚惚俯｜惚疱蜚屦舡铒溴汜篚犰豉忽犰蹂⒚劣樟淘侪蘑弘猸泔钽屦舡殇⒚涡原雹悴疱蜚屦舡铒溴徵忽犰蹂⒋阿弘猸泔钽屦舡殇⒚涡原并悴疱蜚屦舡铒溴箦忽犰蹂⑼弘猸泔钽屦舡殇⒚涡原尝悴疱蜚屦舡铒溴蜥铍忽犰蹂⒅尚弘猸泔钽屦舡殇⒚涡原储悴疱蜚屦舡铒溴栩痦轭忽犰蹂⒈暗弘猸泔钽屦舡殇⒚涡原耽悴疱蜚屦舡铒溴眄惹忽犰蹂⒈舶弘猸泔钽屦舡殇⒚涡原盯悴疱蜚屦舡铒溴羽锊忽犰蹂⒐耿弘猸泔钽屦舡殇⒚涡原发悴疱蜚屦舡铒溴乙忽犰蹂⒈耽弘猸泔钽屦舡殇⒚涡原涪悴疱蜚屦舡铒溴疳轭忽犰蹂⒉弘猸泔钽屦舡殇⒚涡原耿惚悴惚悴惚悴惚悴惚悴惚悴惚悴惚悴悴疱蜚屦舡铒溴汜篚犰豉忽犰蹂汜篚犰豉泞弘猸泔钽屦舡殇⒚涡原雹悴疱蜚屦舡铒溴徵忽犰蹂⒉盯弘猸泔钽屦舡殇⒚涡原并愠疱蜚屦舡铒溴箦忽犰蹂⑼弘猸泔钽屦舡殇⒚涡原尝愠疱蜚屦舡铒溴蜥铍忽犰蹂⑼殪轸狎弘猸泔钽屦舡殇⒚涡原储愠疱蜚屦舡铒溴栩痦轭忽犰蹂⒈舶弘猸泔钽屦舡殇⒚涡原耽愠疱蜚屦舡铒溴眄惹忽犰蹂⒈鞍弘猸泔钽屦舡殇⒚涡原盯愠疱蜚屦舡铒溴羽锊忽犰蹂⒐耽弘猸泔钽屦舡殇⒚涡原发愠疱蜚屦舡铒溴乙忽犰蹂⒈耽弘猸泔钽屦舡殇⒚涡原涪愠疱蜚屦舡铒溴疳轭忽犰蹂⒈阿弘猸泔钽屦舡殇⒚涡原耿悴悴悴愠悴愠悴愠悴愠悴愠悴愠悴愠愠疱蜚屦舡铒溴汜篚犰豉忽犰蹂⒚劣樟淘侪脾弘猸泔钽屦舡殇⒚涡原雹愠疱蜚屦舡铒溴徵忽犰蹂⒈并弘猸泔钽屦舡殇⒚涡原并愠疱蜚屦舡铒溴箦忽犰蹂⑼弘猸泔钽屦舡殇⒚涡原尝愦疱蜚屦舡铒溴蜥铍忽犰蹂⒚芍商闪微弘猸泔钽屦舡殇⒚涡原储愦疱蜚屦舡铒溴栩痦轭忽犰蹂⒈舶弘猸泔钽屦舡殇⒚涡原耽愦疱蜚屦舡铒溴眄惹忽犰蹂⒊阿弘猸泔钽屦舡殇⒚涡原盯愦疱蜚屦舡铒溴羽锊忽犰蹂⒐耿弘猸泔钽屦舡殇⒚涡原发愦疱蜚屦舡铒溴乙忽犰蹂⒉耽弘猸泔钽屦舡殇⒚涡原涪愦疱蜚屦舡铒溴疳轭忽犰蹂⒊弘猸泔钽屦舡殇⒚涡原耿愠愠愠愠愠愦愠愦愠愦愠愦愠愦愠愦磲疸狎＇灬礅溽ㄢ瞟ㄦ矧磲モ詈英忸瘐箬麸屦怩骀弪后翎翦忸洪铙弪舡屦轶镤瀛舂ㄥ祠憝麸痄姗ㄢ蝈犭┅扉篝忸忸博换ㄥ祠憝麸痄姗┅